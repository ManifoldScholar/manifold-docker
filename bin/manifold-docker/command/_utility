#!/usr/bin/env bash

_create_volumes() {
    docker volume create manifold_data
    docker volume create manifold_sockets
}

_run_containers() {
    docker run -d -v manifold_data:/manifold_data -v manifold_sockets:/manifold_sockets manifold_api:latest
    docker run -d -p 4000:80 -v manifold_data:/manifold_data -v manifold_sockets:/manifold_sockets manifold_proxy:latest
}

# Private

_create_docker_machine() {
    if [[ $OSTYPE = *"darwin"* ]]
    then
        case $(docker-machine status manifold1) in
            Stopped)
                docker-machine start manifold1
                ;;
            Running)
                ;;
            *)
                _output "Attempting to bounce the vboxnet0 network interface which requires sudo. Please enter your password if prompted."
                sudo ifconfig vboxnet0 down && sudo ifconfig vboxnet0 up
                docker-machine create --driver virtualbox --virtualbox-memory 4096 manifold1
        esac
        _output "Setting docker-machine environemnt to manifold1"
        eval $(docker-machine env manifold1)
        _output "Running sudo sysctl -w vm.max_map_count=262144 for ElasticSearch"
        docker-machine ssh manifold1 "sudo sysctl -w vm.max_map_count=262144"
    fi
}

_get_docker_machine_ip() {
    if [[ $OSTYPE = *"darwin"* ]]
    then
        docker-machine ip manifold1
    else
        echo 'localhost'
    fi
}

_cleanup_images() {
    standard_message "Cleaning up stale images."
    docker image prune
}

_cleanup_volumes() {
    standard_message "Cleaning up stale volumes."
    docker volume prune
}

_wait_for_curl() {
    local url response
    local "${@}"
    until curl -k -s -o /dev/null -w %{http_code} ${url} | grep "${response}" >/dev/null;
    do
        sleep 5
        echo -n '.'
    done
}

_wait_for_docker_compose() {
    local container command response
    local "${@}"
    until docker-compose -f ${docker_compose_file} run ${container} /bin/bash -c "${command}" | grep "${response}" >/dev/null;
    do
        sleep 5
        echo -n '.'
    done
}

_wait_for_docker_exec() {
    local service command response
    local "${@}"
    until docker exec -ti ${service}.1.$(docker service ps -f "name=${service}.1" ${service} -q) /bin/bash -c "${command}" | grep "${response}" >/dev/null;
    do
        sleep 5
        echo -n '.'
    done
}

_pull_dependencies() {
    local manifold_tag
    local "${@}"
    docker pull dockersamples/visualizer:stable
    docker pull postgres:alpine
    docker pull redis:alpine
    docker pull docker.elastic.co/elasticsearch/elasticsearch:6.1.3
    docker pull manifoldscholar/manifold_api:${manifold_tag}
    docker pull manifoldscholar/manifold_proxy:${manifold_tag}
}

_output() {
    echo -e "\n$1\n"
}
